<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <title>Amazon Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 20px 0;
        }
        
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-idle { background: rgba(100, 100, 100, 0.3); }
        .status-active { background: rgba(255, 107, 53, 0.3); color: #ff6b35; }
        .status-success { background: rgba(46, 204, 113, 0.3); color: #2ecc71; }
        .status-error { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }
        
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            color: #fff;
        }
        
        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .current-job {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }
        
        .current-job h3 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .current-email {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .status-text {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .captcha-container {
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        
        .captcha-container iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        
        .captcha-header {
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            color: #fff;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 4px 0;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .log-entry.success { color: #2ecc71; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.info { color: #3498db; }
        
        .hidden { display: none; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: rgba(255, 107, 53, 0.3);
            color: #ff6b35;
        }
        
        .tab-content {
            margin: 20px 0;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Amazon Generator</h1>
        </div>
        
        <div class="stats-card">
            <div class="stat-item">
                <span class="stat-label">üìß Emails restants</span>
                <span class="stat-value" id="emails-count">-</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üìä Statut</span>
                <span class="status-badge status-idle" id="status-badge">En attente</span>
            </div>
        </div>
        
        <button class="btn btn-primary" id="start-btn" onclick="startGeneration()">
            ‚ñ∂Ô∏è G√©n√©rer un compte
        </button>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('generate')">G√©n√©rer</button>
            <button class="tab-btn" onclick="showTab('emails')">Emails</button>
            <button class="tab-btn" onclick="showTab('accounts')">Comptes</button>
        </div>
        
        <div id="tab-emails" class="tab-content hidden">
            <div class="stats-card">
                <h3 style="margin-bottom: 15px;">üìß Ajouter des emails</h3>
                <textarea id="emails-input" placeholder="Un email par ligne..." rows="5" style="width: 100%; padding: 12px; border-radius: 8px; border: none; background: rgba(0,0,0,0.3); color: #fff; font-family: monospace; resize: vertical;"></textarea>
                <button class="btn btn-primary" onclick="addEmails()" style="margin-top: 10px;">
                    ‚ûï Ajouter les emails
                </button>
            </div>
        </div>
        
        <div id="tab-accounts" class="tab-content hidden">
            <div class="stats-card">
                <h3 style="margin-bottom: 15px;">‚úÖ Comptes cr√©√©s</h3>
                <div id="accounts-list" style="font-family: monospace; font-size: 12px;"></div>
            </div>
        </div>
        
        <div id="tab-generate" class="tab-content">
        
        <div class="current-job hidden" id="current-job">
            <h3>Compte en cours</h3>
            <div class="current-email" id="current-email"></div>
            <div class="status-text" id="status-text"></div>
        </div>
        
        <div class="captcha-container hidden" id="captcha-container">
            <div class="captcha-header">
                <span class="pulse">üîê</span>
                <span>R√©sous le captcha</span>
            </div>
            <iframe id="captcha-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="log-entry info">üîå Connexion au serveur...</div>
        </div>
        </div><!-- fin tab-generate -->
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let isGenerating = false;
        
        // √âl√©ments DOM
        const emailsCount = document.getElementById('emails-count');
        const statusBadge = document.getElementById('status-badge');
        const startBtn = document.getElementById('start-btn');
        const currentJob = document.getElementById('current-job');
        const currentEmail = document.getElementById('current-email');
        const statusText = document.getElementById('status-text');
        const captchaContainer = document.getElementById('captcha-container');
        const captchaIframe = document.getElementById('captcha-iframe');
        const logContainer = document.getElementById('log-container');
        
        // Logs
        function addLog(message, type = '') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Status mapping
        const statusMessages = {
            'idle': '‚è∏Ô∏è En attente',
            'starting': 'üöÄ D√©marrage...',
            'get_form': 'üìù R√©cup√©ration formulaire...',
            'post_register': 'üì§ Envoi inscription...',
            'cvf_captcha': 'üîê Pr√©paration captcha...',
            'waiting_captcha': '‚è≥ Attente r√©solution captcha...',
            'submitting_captcha': '‚úÖ Soumission captcha...',
            'waiting_email_otp': 'üìß Attente code email...',
            'submitting_email_otp': 'üìß Envoi code email...',
            'sms_verification': 'üì± V√©rification SMS...',
            'waiting_sms_otp': 'üì± Attente code SMS...',
            'submitting_sms_otp': 'üì± Envoi code SMS...',
            'saving_account': 'üíæ Sauvegarde compte...',
            'success': '‚úÖ Compte cr√©√©!',
            'failed': '‚ùå √âchec',
            'error_form': '‚ùå Erreur: formulaire non trouv√©',
            'error_captcha_timeout': '‚ùå Timeout captcha'
        };
        
        function updateStatus(status) {
            let message = statusMessages[status] || status;
            
            if (status.startsWith('sms_attempt_')) {
                const attempt = status.split('_')[2];
                message = `üì± Tentative SMS ${attempt}/5...`;
            }
            
            statusText.textContent = message;
            
            // Update badge
            statusBadge.className = 'status-badge';
            if (status === 'success') {
                statusBadge.classList.add('status-success');
                statusBadge.textContent = '‚úÖ Succ√®s';
            } else if (status.includes('error') || status === 'failed') {
                statusBadge.classList.add('status-error');
                statusBadge.textContent = '‚ùå Erreur';
            } else if (status !== 'idle') {
                statusBadge.classList.add('status-active');
                statusBadge.textContent = 'üîÑ En cours';
            } else {
                statusBadge.classList.add('status-idle');
                statusBadge.textContent = 'En attente';
            }
        }
        
        // Socket events
        socket.on('connect', () => {
            addLog('Connect√© au serveur', 'success');
        });
        
        socket.on('disconnect', () => {
            addLog('D√©connect√© du serveur', 'error');
        });
        
        socket.on('stats', (data) => {
            emailsCount.textContent = data.emails_remaining;
        });
        
        socket.on('status_update', (data) => {
            addLog(`Status: ${data.status}`, 'info');
            updateStatus(data.status);
            
            if (data.email) {
                currentEmail.textContent = data.email;
                currentJob.classList.remove('hidden');
            }
            
            if (data.captcha_url) {
                captchaIframe.src = data.captcha_url;
                captchaContainer.classList.remove('hidden');
            }
            
            if (data.status === 'success' || data.status === 'failed' || data.status.includes('error')) {
                isGenerating = false;
                startBtn.disabled = false;
                startBtn.innerHTML = '‚ñ∂Ô∏è G√©n√©rer un compte';
                captchaContainer.classList.add('hidden');
                
                // Refresh stats
                fetch('/api/stats')
                    .then(r => r.json())
                    .then(stats => {
                        emailsCount.textContent = stats.emails_remaining;
                    });
                
                if (data.status === 'success') {
                    addLog(`Compte cr√©√©: ${data.email}`, 'success');
                } else {
                    addLog(`√âchec: ${data.email}`, 'error');
                }
            }
        });
        
        socket.on('captcha_received', () => {
            addLog('Token captcha re√ßu', 'success');
            captchaContainer.classList.add('hidden');
        });
        
        // √âcouter les messages de l'iframe captcha
        window.addEventListener('message', (event) => {
            if (event.data && typeof event.data === 'string') {
                // Chercher le token dans le message
                if (event.data.includes('|r=')) {
                    const tokenMatch = event.data.match(/([a-f0-9]+\|r=[a-zA-Z0-9_\-\.]+)/);
                    if (tokenMatch) {
                        addLog('Captcha r√©solu!', 'success');
                        socket.emit('captcha_solved', { token: tokenMatch[1] });
                    }
                }
            }
            
            // D√©tecter la r√©solution via d'autres formats
            try {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                if (data.token || data.sessionToken) {
                    addLog('Captcha r√©solu!', 'success');
                    socket.emit('captcha_solved', { token: data.token || data.sessionToken });
                }
            } catch (e) {}
        });
        
        // Actions
        function startGeneration() {
            if (isGenerating) return;
            
            isGenerating = true;
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner"></span>G√©n√©ration...';
            
            fetch('/api/start', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        addLog(data.error, 'error');
                        isGenerating = false;
                        startBtn.disabled = false;
                        startBtn.innerHTML = '‚ñ∂Ô∏è G√©n√©rer un compte';
                    } else {
                        addLog(`D√©marrage: ${data.email}`, 'info');
                    }
                })
                .catch(err => {
                    addLog(`Erreur: ${err}`, 'error');
                    isGenerating = false;
                    startBtn.disabled = false;
                    startBtn.innerHTML = '‚ñ∂Ô∏è G√©n√©rer un compte';
                });
        }
        
        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tab === 'accounts') loadAccounts();
        }
        
        // Add emails
        function addEmails() {
            const textarea = document.getElementById('emails-input');
            const emails = textarea.value.trim();
            
            if (!emails) {
                addLog('Aucun email √† ajouter', 'error');
                return;
            }
            
            fetch('/api/emails', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'emails=' + encodeURIComponent(emails)
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    addLog(data.error, 'error');
                } else {
                    addLog(`${data.added} emails ajout√©s (total: ${data.total})`, 'success');
                    textarea.value = '';
                    emailsCount.textContent = data.total;
                }
            })
            .catch(err => addLog('Erreur: ' + err, 'error'));
        }
        
        // Load accounts
        function loadAccounts() {
            fetch('/api/accounts')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('accounts-list');
                if (data.accounts.length === 0) {
                    list.innerHTML = '<p style="color: rgba(255,255,255,0.5);">Aucun compte cr√©√©</p>';
                } else {
                    list.innerHTML = data.accounts.map(a => 
                        `<div style="padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-weight: bold; color: #ff6b35;">${a.email}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px;">Mot de passe: ${a.password}</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 4px;">${a.created_at || ''}</div>
                            ${a.cookies ? `<button onclick="copyCookies('${a.email}')" style="margin-top: 8px; padding: 6px 12px; background: rgba(255,107,53,0.3); border: none; border-radius: 4px; color: #ff6b35; cursor: pointer; font-size: 11px;">üìã Copier cookies</button>` : ''}
                        </div>`
                    ).join('');
                    
                    // Stocker les cookies pour copie
                    window.accountsCookies = {};
                    data.accounts.forEach(a => {
                        window.accountsCookies[a.email] = a.cookies;
                    });
                }
            });
        }
        
        function copyCookies(email) {
            const cookies = window.accountsCookies[email];
            if (cookies) {
                navigator.clipboard.writeText(cookies).then(() => {
                    addLog('Cookies copi√©s!', 'success');
                }).catch(() => {
                    addLog('Erreur copie', 'error');
                });
            }
        }
        
        // Init
        fetch('/api/stats')
            .then(r => r.json())
            .then(stats => {
                emailsCount.textContent = stats.emails_remaining;
                if (stats.active) {
                    isGenerating = true;
                    startBtn.disabled = true;
                    currentJob.classList.remove('hidden');
                    currentEmail.textContent = stats.current_email;
                    updateStatus(stats.status);
                }
            });
    </script>
</body>
</html>
